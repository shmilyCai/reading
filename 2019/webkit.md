# webkit技术内幕

## 1. 浏览器和浏览器内核

HTML5包含了一系列的标准，共包含10个大的类别：
1. 离线（offline）
2. 存储（storage）
3. 连接（connectivity）
4. 文件访问（file access）
5. 语义（semantics）
6. 音频和视频（audio/video）
7. 3D和图形（3D/graphics）
8. 展示（presentation）
9. 性能（performance）
10. 其他（Nuts and bolts）

HTTP是一种构建在TCP/IP之上的应用层协议，用于传输HTML文本和所涉及的各种资源，包括图片和多媒体等。

HTTPS是HTTP的安全版本，加入了SSL/TLS，用于安全地传输数据

渲染就是根据描述或者定义构建数学模型，通过模型生成图像的过程。

浏览器的渲染引擎就是能够将HTML/CSS/Javascript文本及其相应的资源文件转换成图像结果的模块。

渲染引擎主要包括：
1. HTML解释器，解释HTML文本的解释器，主要作用是将HTML文本解释成DOM（文档对象模型）树，DOM是一种文档的表示方法。
2. CSS解释器，级联样式表的解释器，作用是为DOM中的各个元素对象计算出样式信息，从而计算最后网页的布局提供基础设施。
3. 布局，在DOM创建之后，Webkit需要将其中的元素对象同样式信息结合起来，计算它们的大小位置等布局信息，形成一个能够表示这所有信息的内部表示模型，
4. Javascript引擎，使用Javascript代码可以修改网页的内容，也能修改css的信息，JavaScript引擎能够解释JavaScript代码并通过DOM接口和CSSOM接口来修改网页内容和样式信息，从而改变渲染的结果
5. 绘图，使用图形库将布局计算后的各个网页的节点绘制成图像结果。

## 2. HTML网页和结构

着重剖析HTML网页的构成和结构，通过对它们的解释来帮助理解webkit的渲染过程。

###  基本元素和树状结构

HTML 网页就是一种使用HTML语言撰写的文档。

JavaScript代码用来控制网页内部的逻辑。
Javascript是一种解释型的脚本语言，主要目的是控制用户端逻辑，同用户交互等，它可以修改HTML元素及其内容。

CSS用来描述网页的显示信息。

一个完整的网页组成包括HTML文本，JavaScript代码，CSS代码以及各种各样的资源文件。

### HTML5新特性

HTML5最新能力之一：对2D和3D图形以及多媒体的支持

主要包括：
1. HTML5视频，引入video元素，支持在网页中播放视频
2. Canvas 2D，定义canvas元素，利用该元素的2D绘图上下文调用标准定义的接口，绘制常见的2D图形，如点，线，矩形，多变形
3. WebGL（Canvas 3D），使用canvas元素，利用该元素的3D绘图上下文调用标准定义的接口，绘制3D图形
4. CSS3 3D变换（transform）和转换（transition），作用于HTML的任意可视元素，制造出各种炫丽的3D效果

### webkit的网页渲染过程

浏览器的主要作用就是将用户输入的URL转变成可视化的图像。

包含过程：
1. 网页加载过程，就是从URL到构建DOM树
2. 网页渲染过程，从DOM树到生成可视化图像

渲染过程中的数据和模块：
1. 数据包括网页内容，DOM，内部表示和图像，
2. 模块则包括HTML解释器，css解释器，JavaScript引擎以及布局和绘图模块

根据数据的流行，渲染过程的三个阶段：
1. 第一个阶段是从网页的URL到构建完DOM树，
2. 第二个阶段是从DOM树到构建完webkit的绘图上下文
3. 第三个阶段是从绘图上下文到生成最终的图像

从网页到DOM树过程：
1. 当用户输入网页URL的时候，webkit调用其资源加载器加载该URL对应的网页
2. 加载器依赖网络模块建立连接，发送请求并接收答复
3. webkit接收到各种网页或者资源的数据，其中某些资源可能是同步或者异步获取的
4. 网页被交给HTML解释器转变车成一系列的词语（TOKEN）
5. 解释器根据词语构建节点（Node），形成DOM树
6. 如果节点是JavaScript代码的话，调用JavaScript引擎解释并执行
7. JavaScript代码可能会修改DOM树的结构
8. 如果节点需要依赖其他资源，例如图片，css，视频等，调用资源加载器来加载它们，但是它们是异步的，不会阻碍当前DOM树的继续创建；如果是JavaScript资源URL（没有标记异步方式），则需要停止当前DOM树的创建，直到JavaScript的资源加载并被JavaScript引擎执行后才继续DOM树的创建

webkit利用CSS和DOM树创建RenderObject树直到绘图上下文，过程：
1. CSS文件被CSS解释器解释成内部表示结构
2. CSS解释器工作完之后，在DOM树上附加解释器后的样式信息，这就是RenderObject树
3. RenderObject节点在创建的同时，webkit会根据网页的层次结构创建RenderLayer树，同时构建一个虚拟的绘图上下文。

绘图上下文生成最终的图像，过程：
1. 绘图上下文是一个与平台无关的抽象类，它将每个绘图操作桥接到不同的具体实现类，也就是绘图具体实现类
2. 绘图实现类也可能有简单的实现，也可能有复杂的实现
3. 绘图实现类将2D图形库或者3D图形库绘制的结果保存下来，交给浏览器来同浏览器界面一起显示。



## 3. Webkit架构和模块

描述webkit为支持渲染而包含的基本模块和架构，同时结合chromium的架构和实现，来理解webkit的组成和浏览器的组成。

--- 这一章分析webkit架构和源码的，部分看的不是很明白

### 多进程模型

优点：
1. 避免因单个页面的不响应或者崩溃而影响整个浏览器的稳定性，特别是对用户界面的影响
2. 当第三方插件崩溃时不会影响页面或者浏览器的稳定性
3. 方便了安全模型的实施，即沙箱模型是基于多进程架构的

chromium浏览器的进程类型：
1. Browser进程，浏览器的主进程，负责浏览器界面的显示，各个页面的管理，是所有其他类型进程的祖先，负责它们的创建和销毁等工作，有且仅有一个。
2. Renderer进程，网页的渲染进程，负责页面的渲染工作，Blink/Webkit的渲染工作主要在这个进程中完成，可能有多个。
3. NPAPI插件进程，该进程是为了NPAPI类型的插件而创建的。
4. GPU进程，最多只有一个，当且仅当GPU硬件加速打开的时候才会被创建，主要用于对3D图形加速调用的实现
5. Pepper插件进程，同NPAPI插件进程，不同的是为Pepper插件而创建的进程
6. 其他类型的进程，

进程模型总结的特征：
1. Browser进程和页面的渲染是分开的，这保证了页面的渲染导致的崩溃不会导致浏览器主界面的崩溃
2. 每个网页是独立的进程，这保证了页面之间相互不影响
3. 插件进程也是独立的，插件本身的问题不会影响浏览器主界面和网页
4. GPU硬件加速进程也是独立的

### 多线程模型

多线程的主要目的就是为了保持用户界面的高响应度，保证UI线程（Browser进程中的主线程）不会被任何其他费时的操作阻碍从而影响了对用户操作的响应

网页的加载和渲染过程的步骤：
1. Browser进程收到用户的请求，首先由UI线程处理，而且将相应的任务转给IO线程，它随即将该任务传递给Renderer进程
2. Renderer进程的IO线程经过简单解释后交给渲染线程。
3. Browser进程接收到结果并将结果绘制出来


## 4. 资源加载和网络栈

介绍webkit的网络和资源加载机制，以及资源缓存策略。同时，在分析chromium多进程资源加载和全新网络栈和协议基础上，介绍一些HTML网页高效的资源使用方法。

网络和资源加载是网页的加载和渲染过程中的第一步。

HTML支持的资源包括：
1. HTML页面，包括各式各样的HTML元素
2. JavaScript代码，可以内嵌在HTML文件中，也可以单独的文件存在
3. CSS样式表，CSS样式资源
4. 图片，各种编码格式的图片资源，包括png，jpeg等
5. SVG，用于绘制SVG的2D矢量图形表示
6. CSS Shader，支持CSS Shader文件
7. 视频，音频和字幕，多媒体资源及支持音视频的字幕文件
8. 字体文件，CSS支持自定义字体，CSS3引入的自定义字体文件
9. XSL样式表，使用XSLT语言编写的XSLT代码文件


### 缓存

因为效率问题，引入缓存机制，

缓存机制，所有对资源的请求都会先获取缓存中的信息，以决定是否向服务器提出资源请求。

内存缓存：

	资源缓存机制的基本思想是建立一个资源的缓存池，当webkit需要请求资源的时候，先从资源池中查找是否存在相应的资源。如果有，webkit则取出以便使用；如果没有，webkit创建一个新的cachedResource子类的对象，并发送真正的请求给服务器，webkit收到资源后将其设置到该资源类的对象中去，以便于缓存后下次使用。


### 资源加载器

加载器类型：
1. 针对每种资源类型的特定加载器，其特点是仅加载某一种资源
2. 资源缓存机制的资源加载器的特点是所有特定加载器都共享它来查找并插入缓存资源
3. 通用的资源加载器-ResourceLoader类，是在webkit需要从网络或者文件系统获取资源的时候使用该类只负责获得资源的数据，因此被所有特定资源加载器所共享。

当前的主线程被阻碍时，webkit会启动另外一个线程去遍历后面的HTML网页，收集需要的资源URL，然后发送请求，这样就可以避免被阻碍了。

资源池中的资源生命周期使用机制采用LRU（Least Recent Used 最近最少使用）算法。

如何判断资源是否需要加载：
webkit首先判断资源是否在资源池中，如果是，那么发送一个HTTP请求给服务器，说明该资源在本地的一些信息，例如该资源什么时间修改的，服务器则根据该信息作判断，如果没有更新，服务器则发送回状态码304，表明无需更新，那么直接利用资源池中的原来的资源；否则，webkit申请下载最新的资源内容

多进程的资源加载机制


### 网络栈

网络栈的主要模块：
1. HTTP协议
2. DNS解析等模块
3. Chromium为了减少网络时间而引入的新技术，如SPDY，QUIC

域名解析（DNS），用户都是使用域名来访问网络资源的，所以在建立TCP连接前需要解析域名。

为了效率，使用HostCache类来保存解析后的域名，最多时会有多达1000个的域名和地址映射关系会被存储起来。

磁盘本地缓存，提高网页的加载速度。

本地缓存的特点：
1. 虽然需要缓存的资源可能很多，但磁盘空间不是无限大的，所以必须要有相应的机制来移除合适的缓存资源，以便加入新的资源
2. 能够确保在浏览器崩溃时不破坏磁盘文件，至少能够保护原先的磁盘中的数据
3. 能够高效和快速地访问磁盘中现有的数据结构，支持同步和异步两种访问方式
4. 能够避免同时存储两个相同的资源
5. 能够很方便地从磁盘中删除一个项，同时可以在操作一个项的时候不受其他请求的影响
6. 磁盘不支持多线程访问，所以需要把所有磁盘缓存的操作放入单独的一个线程
7. 升级版本时，如果磁盘缓存的内部存储结构发送改变，chromium仍然能够支持老版本的结构。

### Cookie机制

根据cookie的时效性分为2种类型：
1. 会话型Cookie，只保存在内存中
2. 持续型Cookie，当浏览器退出的时候，仍然保留cookie的内容

HTTP是一种使用明文来传输数据的应用层协议，
构建在SSL之上的HTTPS提供了安全的网络传输机制。

Chromium的网络模块有2个重要目标：安全和速度

提高速度：
1. DNS预取，利用现有的DNS机制，提前解析网页中可能的网络连接
2. TCP预连接

Chromium使用追踪技术来获取用户从什么网页跳转到另外一个网页。

HTTP管线化，是一项同时将多个HTTP请求一次性提交给服务器的技术，因此无需等待服务器的回复，因为它可能将多个HTTP请求填充在一个TCP数据包内。

SPDY就是为了解决网络延迟和安全性问题。

QUIC是一种新的网络传输协议，主要目标是改进UDP数据协议的能力。

DNS解析和TCP连接占用大量的时间，高效加载网页的方法：
1. 减少链接的重定向
2. 利用DNS预取机制
3. 搭建支持SPDY协议的服务器，当然指的是那些需要使用HTTPS协议的网站
4. 避免错误的链接请求

减少网页中所需的资源数量来改善网页的加载方法：
1. 在HTML网页中内嵌小型的资源，也就是当资源比较小的时候，开发者可以将它们直接放在网页中，可能的资源如CSS，JavaScript和图片等。
2. 合并一些资源，如CSS，JavaScript和图片

减少资源的数据量来提高网页的加载速度：
1. 使用浏览器本地磁盘缓存机制
2. 启用资源的压缩技术


## 5. HTML解释器和DOM模型

主要介绍DOM模型等方面的技术，并且描述Webkit中HTML解释器和DOM内部表示。

DOM（Document Object Model）的全程是文档对象模型。

DOM结构构成的基本要素是节点，而文档的DOM结构就是由层次化的节点组成。

整个文档（Document）就是一个节点，称为文档节点。

HTML中的标记（Tag）也是一种节点，成为元素节点。

众多的节点按照层次组织构成一个DOM树形结构。

HTML解释器的工作就是将网络或者本地磁盘获取的HTML网页和资源从字节流解释成DOM树结构。

从资源的字节流到DOM树：
1. 首先是字节流，经过解码之后是字符流
2. 然后通过词法分析器会被解释成词语（Tokens）
3. 之后经过语法分析器构建成节点
4. 最后这些节点被组建成一棵DOM树

词法分析的工作是一个状态机，输入的是字符串，输出的是一个个词语。

词法分析器的主要接口是nextToken函数，调用者只需要将字符串传入，然后就会得到一个词语，并对传入的字符串设置相应的信息，表示当前处理完的位置，如此循环。

线程化的解释器就是利用单独的线程来解释HTML文档。

全局执行的JavaScript代码不能访问DOM树的原因-因为DOM树还没有被创建完。

### DOM事件机制

事件处理最重要的部分是：
1. 事件捕获，是自顶向下
2. 事件冒泡，是自底向上
3. stopPropagation函数，用来阻止事件的传递

### 影子（Shadow）DOM

影子DOM主要解决了一个文档中可能需要大量交互的多个DOM树建立和维护各自的功能边界的问题。

影子DOM的规范草案能够使得一些DOM节点在特定范围内可见，而在网页的DOM树中却不可见，但是网页渲染的结果中包含了这些节点。

JavaScript代码访问HTML文档的DOM树的时候，通常的接口是不能直接访问到影子DOM子树中的节点的，而JavaScript代码只能通过特殊的接口方式。


## 6. CSS解释器和样式布局

详解css解释器，并描述CSS3的新功能和webkit的支持情况。之后，分析webkit如何利用css来计算布局的过程。








## 7. 渲染基础

介绍目前的渲染方式以及根据网页结构来设计支持渲染的各种内部数据表示，包括RenderObject树和RenderLayer树，最后详细展现软件渲染网页的过程










## 8. 硬件加速机制

描述GPU硬件在目前渲染中所起的作用。现代浏览器越来越依赖GPU硬件加速渲染基础，特别是HTML5引入的众多标准。









## 9. Javascript引擎

专注于现代JavaScript引擎的介绍，包括JavaScript和V8引擎，描述它们在网页渲染中的作用









## 10. 插件和JavaScript扩展

介绍浏览器中的插件机制和扩展机制，包括webkit的NPAPI插件机制，chromium浏览器中的扩展机制，PPAPI机制和NativeClient技术，通过这些技术可以增加JavaScriptAPI在扩展JavaScript语言中的能力











## 11. 多媒体

专注于Webkit对多媒体方面的支持，包括音频和视频。
详解webkit的内部原理和对最新的html5视频及音频的支持。












## 12. 安全机制

描述HTML指定的网页安全规范并解释webkit和chromium浏览器的应对之策。













## 13. 移动WebKit

描述webkit支持移动领域特定的功能，同时也包括新的渲染机制。












## 14. 调试机制

详解webkit中的调试模块webInspector，包括结构和原理等。












## 15. Web前端的未来

谈对web未来发展的看法和目前一些明显的趋势。




















